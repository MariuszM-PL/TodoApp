<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:TodoApp.ViewModels"
             xmlns:models="clr-namespace:TodoApp.Models"
             x:Class="TodoApp.Views.TodoPage"
             x:DataType="vm:TodoViewModel"
             Shell.BackButtonBehavior="{BackButtonBehavior IsVisible=False}"
             >

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Dodaj" Command="{Binding GoToAddPageCommand}">
            <ToolbarItem.IconImageSource>
                <FontImageSource Glyph="&#xff0b;" Color="{DynamicResource Primary}" Size="24" FontFamily="OpenSansRegular"/>
            </ToolbarItem.IconImageSource>
        </ToolbarItem>
        <ToolbarItem Text="Ustawienia" Command="{Binding GoToSettingsCommand}">
            <ToolbarItem.IconImageSource>
                <FontImageSource Glyph="&#x2699;" Color="{DynamicResource Primary}" Size="24" FontFamily="OpenSansRegular"/>
            </ToolbarItem.IconImageSource>
        </ToolbarItem>
        <ToolbarItem Text="Wyloguj" Command="{Binding LogoutCommand}">
            <ToolbarItem.IconImageSource>
                <FontImageSource Glyph="&#x23FB;" Color="{DynamicResource Primary}" Size="24" FontFamily="OpenSansRegular"/>
            </ToolbarItem.IconImageSource>
        </ToolbarItem>
    </ContentPage.ToolbarItems>

    <Grid BackgroundColor="{AppThemeBinding Light=#E3E8EE, Dark=#121212}">

        <Grid RowDefinitions="Auto, *, Auto" 
              Padding="20,10,20,0" 
              RowSpacing="15"
              MaximumWidthRequest="900"
              HorizontalOptions="Center">

            <VerticalStackLayout Grid.Row="0" Spacing="15">
                <Label Text="Moje Zadania" FontSize="28" FontAttributes="Bold" TextColor="{DynamicResource Primary}" Margin="0,10,0,0"/>

                <SearchBar Placeholder="Szukaj zadania..." 
                           Text="{Binding SearchText}" 
                           BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                           CancelButtonColor="{DynamicResource Primary}"/>

                <FlexLayout BindableLayout.ItemsSource="{Binding FilterOptions}" Wrap="Wrap" JustifyContent="Start">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="vm:FilterOption">
                            <Border StrokeShape="RoundRectangle 20" 
                                    Padding="15,8" 
                                    StrokeThickness="0" 
                                    Margin="0,0,10,10">
                                <Border.Shadow>
                                    <Shadow Brush="Black" Offset="0,2" Radius="3" Opacity="0.1"/>
                                </Border.Shadow>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TodoViewModel}}, Path=SelectFilterCommand}" CommandParameter="{Binding .}"/>
                                </Border.GestureRecognizers>
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                        <Setter Property="BackgroundColor" Value="{DynamicResource Primary}" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="False">
                                        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=White, Dark=#2C2C2C}" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Label Text="{Binding Name}" FontSize="13" FontAttributes="Bold">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsSelected}" Value="True">
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsSelected}" Value="False">
                                            <Setter Property="TextColor" Value="{AppThemeBinding Light=Black, Dark=White}" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </Border>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </FlexLayout>
            </VerticalStackLayout>

            <CollectionView Grid.Row="1" ItemsSource="{Binding Tasks}" SelectionMode="None" Margin="0,5,0,0">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="12" />
                </CollectionView.ItemsLayout>

                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Opacity="0.5" Spacing="10">
                        <Label Text="&#x1f4ca;" FontSize="50" HorizontalOptions="Center"/>
                        <Label Text="Brak zadań do wyświetlenia" HorizontalOptions="Center" FontSize="16"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:TodoItem">

                        <Border StrokeShape="RoundRectangle 15"
                                StrokeThickness="0"
                                Padding="15"
                                Margin="2"
                                BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}">

                            <Border.Shadow>
                                <Shadow Brush="Black" Offset="0,3" Radius="5" Opacity="0.08"/>
                            </Border.Shadow>

                            <Grid ColumnDefinitions="Auto, *, Auto" ColumnSpacing="15">

                                <Border Grid.Column="0" 
                                        HeightRequest="28" 
                                        WidthRequest="28" 
                                        StrokeShape="RoundRectangle 10" 
                                        StrokeThickness="2" 
                                        VerticalOptions="Center"
                                        HorizontalOptions="Center">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TodoViewModel}}, Path=ToggleDoneCommand}" CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>

                                    <Label Text="✓" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" FontSize="16" FontAttributes="Bold" IsVisible="{Binding IsDone}"/>

                                    <Border.Triggers>
                                        <DataTrigger TargetType="Border" Binding="{Binding IsDone}" Value="True">
                                            <Setter Property="BackgroundColor" Value="#2ECC71" />
                                            <Setter Property="Stroke" Value="#2ECC71" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Border" Binding="{Binding IsDone}" Value="False">
                                            <Setter Property="BackgroundColor" Value="Transparent" />
                                            <Setter Property="Stroke" Value="{AppThemeBinding Light=#CCCCCC, Dark=#555555}" />
                                        </DataTrigger>
                                    </Border.Triggers>
                                </Border>

                                <VerticalStackLayout Grid.Column="1" Spacing="3" VerticalOptions="Center">

                                    <Label Text="{Binding Category}" FontSize="11" TextColor="{Binding CategoryColor}" FontAttributes="Bold" TextTransform="Uppercase"/>

                                    <Label Text="{Binding Title}" FontSize="16" FontAttributes="Bold" LineBreakMode="TailTruncation">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsDone}" Value="True">
                                                <Setter Property="TextDecorations" Value="Strikethrough" />
                                                <Setter Property="TextColor" Value="Gray" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>

                                    <Label Text="{Binding Description}" FontSize="13" TextColor="Gray" LineBreakMode="TailTruncation" MaxLines="2">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsDone}" Value="True">
                                                <Setter Property="TextDecorations" Value="Strikethrough" />
                                                <Setter Property="Opacity" Value="0.5" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>

                                    <HorizontalStackLayout Spacing="5">
                                        <Label Text="&#x1f4c5;" FontSize="11" TextColor="Gray" VerticalOptions="Center"/>
                                        <Label Text="{Binding DueDate, StringFormat='{0:dd/MM/yyyy HH:mm}'}" FontSize="11" TextColor="Gray" VerticalOptions="Center">
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label" Binding="{Binding IsDone}" Value="True">
                                                    <Setter Property="TextDecorations" Value="Strikethrough" />
                                                    <Setter Property="Opacity" Value="0.5" />
                                                </DataTrigger>
                                            </Label.Triggers>
                                        </Label>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>

                                <HorizontalStackLayout Grid.Column="2" Spacing="0" VerticalOptions="Center">

                                    <ImageButton Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TodoViewModel}}, Path=TapCommand}" 
                                                 CommandParameter="{Binding .}" 
                                                 HeightRequest="40" 
                                                 WidthRequest="40" 
                                                 BackgroundColor="Transparent">
                                        <ImageButton.Source>
                                            <FontImageSource Glyph="&#x270e;" FontFamily="OpenSansRegular" Color="{DynamicResource Primary}" Size="20"/>
                                        </ImageButton.Source>
                                    </ImageButton>

                                    <ImageButton Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TodoViewModel}}, Path=DeleteTaskCommand}" 
                                                 CommandParameter="{Binding .}" 
                                                 HeightRequest="40" 
                                                 WidthRequest="40" 
                                                 BackgroundColor="Transparent">
                                        <ImageButton.Source>
                                            <FontImageSource Glyph="&#x1f5d1;" FontFamily="OpenSansRegular" Color="#FF5252" Size="20"/>
                                        </ImageButton.Source>
                                    </ImageButton>
                                </HorizontalStackLayout>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <HorizontalStackLayout Grid.Row="2" HorizontalOptions="Center" Opacity="0.4" Spacing="8" Margin="0,10,0,20">
                <Label Text="TodoApp 2026" FontSize="12" VerticalOptions="Center"/>
                <Image Source="logo.png" HeightRequest="16" WidthRequest="16" Aspect="AspectFit"/>
            </HorizontalStackLayout>

        </Grid>

        <Button Text="+"
                Command="{Binding GoToAddPageCommand}"
                FontSize="32"
                TextColor="White"
                BackgroundColor="{DynamicResource Primary}"
                HeightRequest="60"
                WidthRequest="60"
                CornerRadius="30"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="0,0,25,25"
                Padding="0"
                ZIndex="500">
            <Button.Shadow>
                <Shadow Brush="{DynamicResource Primary}" Offset="0,4" Radius="8" Opacity="0.5"/>
            </Button.Shadow>
        </Button>

        <Border x:Name="NotificationToast" 
                VerticalOptions="Start" 
                HorizontalOptions="Center" 
                Margin="20,10" 
                Padding="20,12" 
                TranslationY="-500" 
                BackgroundColor="{DynamicResource Primary}" 
                StrokeShape="RoundRectangle 20" 
                ZIndex="1000" 
                HeightRequest="70" 
                WidthRequest="350">
            <Border.Shadow>
                <Shadow Brush="Black" Offset="0,8" Radius="15" Opacity="0.3"/>
            </Border.Shadow>
            <Grid ColumnDefinitions="Auto, *" ColumnSpacing="15">
                <Label Text="&#x1f514;" FontSize="24" VerticalOptions="Center" TextColor="White"/>
                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                    <Label Text="Przypomnienie!" FontAttributes="Bold" TextColor="White" FontSize="14"/>
                    <Label Text="{Binding CurrentNotificationTask.Title}" TextColor="White" FontSize="12" LineBreakMode="TailTruncation"/>
                </VerticalStackLayout>
            </Grid>
        </Border>

    </Grid>
</ContentPage>