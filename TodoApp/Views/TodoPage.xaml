<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:TodoApp.ViewModels"
             xmlns:models="clr-namespace:TodoApp.Models"
             x:Class="TodoApp.Views.TodoPage"
             x:DataType="vm:TodoViewModel"
             Title="Moje Zadania">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Ustawienia" Command="{Binding GoToSettingsCommand}">
            <ToolbarItem.IconImageSource>
                <FontImageSource Glyph="&#x2699;" Color="{DynamicResource Primary}" Size="24" FontFamily="OpenSansRegular"/>
            </ToolbarItem.IconImageSource>
        </ToolbarItem>
        <ToolbarItem Text="Wyloguj" Command="{Binding LogoutCommand}" Order="Primary" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto, *" Padding="20" RowSpacing="20">

        <VerticalStackLayout Grid.Row="0" Spacing="15">
            <Label Text="Nowe zadanie" FontAttributes="Bold" FontSize="20" TextColor="{DynamicResource Primary}"/>
            <Entry Placeholder="Tytuł zadania" Text="{Binding NewTodoTitle}" />
            <Editor Placeholder="Opis (opcjonalnie)" 
                    Text="{Binding NewTodoDescription}" />
            <DatePicker Date="{Binding NewTodoDate}" 
                        MinimumDate="01/01/2020" 
                        Format="dd/MM/yyyy" />

            <Button Text="Dodaj zadanie" Command="{Binding AddTaskCommand}" HeightRequest="55" Margin="0,10,0,0" />
        </VerticalStackLayout>

        <CollectionView Grid.Row="1" ItemsSource="{Binding Tasks}" SelectionMode="None">
            <CollectionView.EmptyView>
                <Label Text="Brak zadań." HorizontalOptions="Center" VerticalOptions="Center" TextColor="{DynamicResource Gray400}" FontSize="18"/>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:TodoItem">
                    <Frame Margin="0,8">
                        <Grid ColumnDefinitions="Auto, *, Auto, Auto" ColumnSpacing="10" VerticalOptions="Center">

                            <Border Grid.Column="0" 
                                    HeightRequest="24" 
                                    WidthRequest="24" 
                                    StrokeShape="RoundRectangle 12" 
                                    Stroke="{DynamicResource Primary}" 
                                    StrokeThickness="2" 
                                    BackgroundColor="Transparent"
                                    VerticalOptions="Center" 
                                    HorizontalOptions="Center">

                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TodoViewModel}}, Path=ToggleDoneCommand}" 
                                        CommandParameter="{Binding .}"/>
                                </Border.GestureRecognizers>

                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsDone}" Value="True">
                                        <Setter Property="BackgroundColor" Value="{DynamicResource Primary}" />
                                    </DataTrigger>
                                </Border.Triggers>
                            </Border>

                            <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                <Label Text="{Binding Title}" FontSize="16" FontAttributes="Bold">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsDone}" Value="True">
                                            <Setter Property="TextDecorations" Value="Strikethrough" />
                                            <Setter Property="TextColor" Value="{DynamicResource Gray400}" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsDone}" Value="False">
                                            <Setter Property="TextDecorations" Value="None" />
                                            <Setter Property="TextColor" Value="{DynamicResource AppText}" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>

                                <Label FontSize="12" TextColor="{DynamicResource GrayText}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding Description}" />
                                            <Span Text=" • " />
                                            <Span Text="{Binding DueDate, StringFormat='{0:dd/MM/yyyy}'}" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsDone}" Value="True">
                                            <Setter Property="TextDecorations" Value="Strikethrough" />
                                            <Setter Property="TextColor" Value="{DynamicResource Gray400}" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </VerticalStackLayout>

                            <ImageButton Grid.Column="2" 
                                         Source="{FontImageSource Glyph='&#x270F;', Color={DynamicResource Primary}, Size=20}"
                                         BackgroundColor="Transparent"
                                         Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TodoViewModel}}, Path=TapCommand}"
                                         CommandParameter="{Binding .}" 
                                         VerticalOptions="Center"
                                         HeightRequest="40" 
                                         WidthRequest="40"/>

                            <ImageButton Grid.Column="3" 
                                         Source="{FontImageSource Glyph='&#x1F5D1;', Color={DynamicResource Gray400}, Size=20}"
                                         BackgroundColor="Transparent"
                                         Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TodoViewModel}}, Path=DeleteTaskCommand}"
                                         CommandParameter="{Binding .}" 
                                         VerticalOptions="Center"
                                         HeightRequest="40" 
                                         WidthRequest="40"/>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>